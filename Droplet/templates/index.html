<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TallinnAtomHub</title>
  <link rel="stylesheet" href="/static/hub.css">
  <script src="/static/hub.js" defer></script>
</head>

<body>
  <div class="card">
    <div class="title">TallinnAtomHub</div>

    <div class="subtitle">
      <span>Team: {{ team }}</span>
      <span>· Bucket: {{ bucket }}</span>
      <span>· <a href="/health">health</a></span>
      <span class="muted">· SSE: {{ sse_ms }}ms</span>
      <span class="muted">· server: <span class="mono" id="server-time">{{ server_time }}</span></span>
      <span class="muted" id="conn-state">· connecting...</span>
    </div>

    <div class="table-wrap">
      <table>
        <colgroup>
          <col class="device">
          <col class="status">
          <col class="valve">
          <col class="now">
          <col class="prev">
          <col class="delta">
          <col class="time">
          <col class="view">
        </colgroup>

        <thead>
          <tr>
            <th>Device</th>
            <th>Status</th>
            <th>Valve</th>
            <th>Now</th>
            <th>Prev</th>
            <th>Δ</th>
            <th>Last seen (UTC)</th>
            <th>View</th>
          </tr>
        </thead>

        <tbody id="devices-body">
          {% for d in devices %}
          <tr data-uid="{{ d.device_id }}">
            <td class="mono" data-k="device_id">{{ d.device_id }}</td>

            <td data-k="status">
              <span class="pill {{ 'offline' if d.offline else 'open' }}">
                {{ 'Offline' if d.offline else 'Online' }}
              </span>
            </td>

            <td data-k="valve">
              <span class="pill mono">{{ d.valve_state or '-' }}</span>
            </td>

            <td data-k="now">
              <span class="pill mono {{ 'alarm' if d.pressure_now and d.pressure_now > 5 else '' }}">
                {{ "%.3f"|format(d.pressure_now) if d.pressure_now is not none else '-' }}
              </span>
            </td>

            <td class="mono" data-k="prev">
              {{ "%.3f"|format(d.pressure_prev) if d.pressure_prev is not none else '-' }}
            </td>

            <td class="mono" data-k="delta">
              {{ "%.3f"|format(d.delta) if d.delta is not none else '-' }}
            </td>

            <td class="mono" data-k="time">{{ d.time_utc }}</td>

            <td data-k="view">
              <a class="view-link {{ '' if d.has_view else 'disabled' }}" href="/device/{{ d.device_id }}">
                {{ 'Open' if d.has_view else 'No init' }}
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </div>
</body>
</html>
