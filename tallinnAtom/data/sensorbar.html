<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8">
  <title>Sensorseadme olek</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    *{
      box-sizing:border-box;
    }
    body{
      margin:0;
      padding:40px 16px;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#0f172a 0,#020617 55%,#000 100%);
      color:#e5e7eb;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:24px;
      min-height:100vh;
    }

    .card{
      position:relative;
      background:#020617;
      border-radius:26px;
      padding:32px 40px;
      min-width:480px;
      max-width:720px;
      width:100%;
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 35px 120px rgba(15,23,42,0.95);
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:30px;
      background:conic-gradient(
        from 140deg,
        rgba(56,189,248,0.0),
        rgba(56,189,248,0.65),
        rgba(129,140,248,0.8),
        rgba(56,189,248,0.0)
      );
      opacity:0.35;
      z-index:-1;
      filter:blur(12px);
    }

    .title{
      font-size:32px;
      font-weight:700;
      letter-spacing:0.05em;
      text-transform:uppercase;
      margin-bottom:6px;
      background:linear-gradient(120deg,#60a5fa,#a855f7,#22d3ee);
      -webkit-background-clip:text;
      color:transparent;
    }

    .subtitle{
      font-size:14px;
      color:#94a3b8;
      margin-bottom:26px;
      text-transform:uppercase;
      letter-spacing:0.16em;
    }

    .grid{
      margin-top:10px;
    }

    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 0;
      border-bottom:1px solid rgba(30,64,175,0.35);
      font-size:15px;
    }
    .row:last-child{
      border-bottom:none;
    }

    .label{
      color:#9ca3af;
      text-transform:uppercase;
      letter-spacing:0.12em;
      font-size:12px;
    }

    .value{
      font-family:"JetBrains Mono","Fira Code",Consolas,monospace;
      font-size:16px;
      font-weight:500;
      color:#e5e7eb;
      padding:4px 10px;
      min-width:150px;
      text-align:right;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      box-shadow:0 0 14px rgba(37,99,235,0.45);
      transition:background-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
    }

    .value.placeholder{
      color:#6b7280;
      box-shadow:none;
    }

    /* ðŸ”´ ALARM: rÃµhk praegu > 5 bar */
    .value.alarm{
      background:rgba(127,29,29,0.96);
      color:#fee2e2;
      box-shadow:0 0 22px rgba(248,113,113,0.95);
      animation:alarmPulse 0.8s ease-in-out infinite;
    }

    @keyframes alarmPulse{
      0%{
        transform:scale(1);
        box-shadow:0 0 16px rgba(248,113,113,0.7);
      }
      50%{
        transform:scale(1.05);
        box-shadow:0 0 30px rgba(248,113,113,1);
      }
      100%{
        transform:scale(1);
        box-shadow:0 0 16px rgba(248,113,113,0.7);
      }
    }

    .chart-card{
      position:relative;
      background:#020617;
      border-radius:26px;
      padding:24px 30px 30px 30px;
      min-width:480px;
      max-width:900px;
      width:100%;
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 35px 120px rgba(15,23,42,0.95);
      overflow:hidden;
    }
    .chart-card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:30px;
      background:conic-gradient(
        from 320deg,
        rgba(56,189,248,0.0),
        rgba(56,189,248,0.6),
        rgba(52,211,153,0.7),
        rgba(56,189,248,0.0)
      );
      opacity:0.25;
      z-index:-1;
      filter:blur(14px);
    }
    .chart-title{
      font-size:18px;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
      margin-bottom:4px;
      color:#a5b4fc;
    }
    .chart-subtitle{
      font-size:12px;
      color:#64748b;
      margin-bottom:16px;
      letter-spacing:0.16em;
      text-transform:uppercase;
    }
    .chart-wrapper{
      position:relative;
      width:100%;
      height:320px;
    }

    @media (max-width:640px){
      body{
        padding:24px 8px;
      }
      .card,
      .chart-card{
        padding:24px 18px;
        min-width:0;
        width:100%;
      }
      .value{
        min-width:120px;
        font-size:14px;
      }
      .chart-wrapper{
        height:260px;
      }
    }
  </style>
</head>
<body>
  <!-- STAATUSPANEEL -->
  <div class="card">
    <div class="title">Sensorseadme olek</div>
    <div class="subtitle">Andmed uuendatakse mqtt sÃµnumite pÃµhjal</div>

    <div class="grid">
      <div class="row">
        <div class="label">Seadme identifikator</div>
        <div class="value placeholder" id="device-uid">---</div>
      </div>

      <div class="row">
        <div class="label">Timestamp (ms)</div>
        <div class="value placeholder" id="ts-ms">---</div>
      </div>

      <div class="row">
        <div class="label">Klapi olek</div>
        <div class="value placeholder" id="valve-state">---</div>
      </div>

      <div class="row">
        <div class="label">RÃµhk 30 ms tagasi</div>
        <div class="value placeholder" id="pressure-prev">---</div>
      </div>

      <div class="row">
        <div class="label">RÃµhk praegu</div>
        <div class="value placeholder" id="pressure-now">---</div>
      </div>
    </div>
  </div>

  <!-- GRAAFIK -->
  <div class="chart-card">
    <div class="chart-title">RÃ•HU REAALAEGNE GRAAFIK</div>
    <div class="chart-subtitle">pressure_now Â· 5 bar alarmijoon</div>
    <div class="chart-wrapper">
      <canvas id="pressureChart"></canvas>
    </div>
  </div>

  <!-- Chart.js + annotation plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

  <script>
    // ---------- STAATUSPANEELI UUENDAMINE ----------
    function setValue(id, value){
      const el = document.getElementById(id);
      el.textContent = value;
      el.classList.remove("placeholder");
    }

    // ---------- CHART.JS KONFIG ----------
    const ctx = document.getElementById("pressureChart").getContext("2d");

    const pressureChartData = {
      labels: [],
      datasets: [
        {
          label: "RÃµhk praegu",
          data: [],
          tension: 0.25,
          borderWidth: 2,
          borderColor: "rgba(56,189,248,1)",
          backgroundColor: "rgba(56,189,248,0.15)",
          pointRadius: 0
        }
      ]
    };

    const pressureChart = new Chart(ctx, {
      type: "line",
      data: pressureChartData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 200
        },
        plugins: {
          legend: {
            labels: {
              color: "#e5e7eb",
              font: { size: 11 }
            }
          },
          tooltip: {
            mode: "index",
            intersect: false
          },
          // ðŸ”´ 5 bar horisontaalne alarmijoon
          annotation: {
            annotations: {
              dangerLine: {
                type: "line",
                yMin: 5,
                yMax: 5,
                borderColor: "rgba(255,75,75,1)",
                borderWidth: 2,
                borderDash: [6,6],
                label: {
                  enabled: true,
                  content: "5 bar piir",
                  color: "#ff4b4b",
                  backgroundColor: "rgba(0,0,0,0.6)",
                  position: "end",
                  font: {
                    size: 11,
                    family: "JetBrains Mono, monospace"
                  }
                }
              }
            }
          }
        },
        interaction: {
          mode: "index",
          intersect: false
        },
        scales: {
          x: {
            ticks: {
              color: "#9ca3af",
              maxRotation: 0,
              autoSkip: true,
              autoSkipPadding: 12
            },
            grid: {
              color: "rgba(30,64,175,0.35)"
            },
            title: {
              display: true,
              text: "Aeg (viimane N mÃµÃµtmist)",
              color: "#6b7280",
              font: { size: 11 }
            }
          },
          y: {
            ticks: { color: "#9ca3af" },
            grid: { color: "rgba(30,64,175,0.25)" },
            title: {
              display: true,
              text: "RÃµhk (bar)",
              color: "#6b7280",
              font: { size: 11 }
            }
          }
        }
      }
    });

    const MAX_POINTS = 120;

    // ---------- KESKNE FUNKTSIOON, MIDA MQTT KUTSUB ----------
    function handleSensorUpdate(payload){
      // payload = { uid, ts_ms, valve_state, pressure_prev, pressure_now }

      setValue("device-uid", payload.uid);
      setValue("ts-ms", payload.ts_ms);
      setValue("valve-state", payload.valve_state);
      setValue("pressure-prev", payload.pressure_prev);
      setValue("pressure-now", payload.pressure_now);

      const label = new Date(payload.ts_ms).toLocaleTimeString("et-EE",{hour12:false});
      pressureChartData.labels.push(label);
      pressureChartData.datasets[0].data.push(payload.pressure_now);

      if (pressureChartData.labels.length > MAX_POINTS){
        pressureChartData.labels.shift();
        pressureChartData.datasets[0].data.shift();
      }

      pressureChart.update("none");

      // ðŸ”´ lÃ¼lita "RÃµhk praegu" pill alarm-reÅ¾iimi kui > 5 bar
      const pressureNowEl = document.getElementById("pressure-now");
      const p = parseFloat(payload.pressure_now);
      if (!isNaN(p) && p > 5){
        pressureNowEl.classList.add("alarm");
      } else {
        pressureNowEl.classList.remove("alarm");
      }
    }

    // ---------- DEMO: PSEUDO-LIVE ANDMED (eemalda pÃ¤ris sÃ¼steemis) ----------
    let demoTs = Date.now();
    let basePressure = 4.7; // nii, et vahel Ã¼letab 5 bar

    function simulateIncomingData(){
      demoTs += 500;
      basePressure += (Math.random() - 0.5) * 0.25;
      const now = +(basePressure + Math.sin(demoTs / 2500) * 0.3).toFixed(3);
      const prev = +(now - 0.03 + (Math.random() - 0.5) * 0.02).toFixed(3);
      const valve = now > 5 ? "lahti" : "kinni";

      const payload = {
        uid: "sensor-3bar-001",
        ts_ms: demoTs,
        valve_state: valve,
        pressure_prev: prev,
        pressure_now: now
      };

      handleSensorUpdate(payload);
    }

    setInterval(simulateIncomingData, 500);
  </script>
</body>
</html>
