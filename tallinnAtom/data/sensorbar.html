<!-- TallinnAtom device init fragment (safe to embed) -->
<div id="ta-root">
  <style>
    /* Scope EVERYTHING into #ta-root so it won't break the outer Flask page */
    #ta-root * { box-sizing: border-box; }

    #ta-root{
      width:100%;
      display:flex;
      flex-direction:column;
      gap:24px;
      align-items:center;
    }

    #ta-root .card{
      position:relative;
      background:#020617;
      border-radius:26px;
      padding:32px 40px;
      width:100%;
      max-width:720px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 35px 120px rgba(15,23,42,0.95);
      overflow:hidden;
    }

    #ta-root .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:30px;
      background:conic-gradient(
        from 140deg,
        rgba(56,189,248,0.0),
        rgba(56,189,248,0.65),
        rgba(129,140,248,0.8),
        rgba(56,189,248,0.0)
      );
      opacity:0.35;
      z-index:0;
      filter:blur(12px);
    }

    #ta-root .inner{
      position:relative;
      z-index:1;
    }

    #ta-root .title{
      font-size:28px;
      font-weight:700;
      letter-spacing:0.05em;
      text-transform:uppercase;
      margin-bottom:6px;
      background:linear-gradient(120deg,#60a5fa,#a855f7,#22d3ee);
      -webkit-background-clip:text;
      color:transparent;
    }

    #ta-root .subtitle{
      font-size:13px;
      color:#94a3b8;
      margin-bottom:22px;
      text-transform:uppercase;
      letter-spacing:0.16em;
    }

    #ta-root .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:14px;
      padding:10px 0;
      border-bottom:1px solid rgba(30,64,175,0.35);
      font-size:15px;
    }
    #ta-root .row:last-child{ border-bottom:none; }

    #ta-root .label{
      color:#9ca3af;
      text-transform:uppercase;
      letter-spacing:0.12em;
      font-size:12px;
      flex:1;
      min-width:160px;
    }

    #ta-root .value{
      font-family:"JetBrains Mono","Fira Code",Consolas,monospace;
      font-size:16px;
      font-weight:500;
      color:#e5e7eb;
      padding:4px 10px;
      min-width:170px;
      text-align:right;
      border-radius:999px;
      background:rgba(15,23,42,0.9);
      box-shadow:0 0 14px rgba(37,99,235,0.45);
      transition:background-color 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
      white-space:nowrap;
    }

    #ta-root .value.placeholder{
      color:#6b7280;
      box-shadow:none;
    }

    /* ALARM: pressure_now > 5 bar */
    #ta-root .value.alarm{
      background:rgba(127,29,29,0.96);
      color:#fee2e2;
      box-shadow:0 0 22px rgba(248,113,113,0.95);
      animation:taAlarmPulse 0.8s ease-in-out infinite;
    }

    @keyframes taAlarmPulse{
      0%{ transform:scale(1); box-shadow:0 0 16px rgba(248,113,113,0.7); }
      50%{ transform:scale(1.05); box-shadow:0 0 30px rgba(248,113,113,1); }
      100%{ transform:scale(1); box-shadow:0 0 16px rgba(248,113,113,0.7); }
    }

    #ta-root .chart-card{
      position:relative;
      background:#020617;
      border-radius:26px;
      padding:24px 30px 30px 30px;
      width:100%;
      max-width:900px;
      box-shadow:
        0 0 0 1px rgba(15,23,42,0.9),
        0 35px 120px rgba(15,23,42,0.95);
      overflow:hidden;
    }

    #ta-root .chart-card::before{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius:30px;
      background:conic-gradient(
        from 320deg,
        rgba(56,189,248,0.0),
        rgba(56,189,248,0.6),
        rgba(52,211,153,0.7),
        rgba(56,189,248,0.0)
      );
      opacity:0.25;
      z-index:0;
      filter:blur(14px);
    }

    #ta-root .chart-inner{ position:relative; z-index:1; }

    #ta-root .chart-title{
      font-size:16px;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
      margin-bottom:4px;
      color:#a5b4fc;
    }

    #ta-root .chart-subtitle{
      font-size:12px;
      color:#64748b;
      margin-bottom:16px;
      letter-spacing:0.16em;
      text-transform:uppercase;
    }

    #ta-root .chart-wrapper{
      position:relative;
      width:100%;
      height:320px;
    }

    @media (max-width:640px){
      #ta-root .card,
      #ta-root .chart-card{
        padding:24px 18px;
      }
      #ta-root .value{
        min-width:130px;
        font-size:14px;
      }
      #ta-root .label{
        min-width:120px;
      }
      #ta-root .chart-wrapper{
        height:260px;
      }
    }
  </style>

  <!-- STATUS PANEL -->
  <div class="card">
    <div class="inner">
      <div class="title">Sensorseadme olek</div>
      <div class="subtitle">Andmed uuendatakse mqtt sõnumite põhjal</div>

      <div class="row">
        <div class="label">Seadme identifikator</div>
        <div class="value placeholder" id="ta-device-uid">---</div>
      </div>

      <div class="row">
        <div class="label">Timestamp (ms)</div>
        <div class="value placeholder" id="ta-ts-ms">---</div>
      </div>

      <div class="row">
        <div class="label">Klapi olek</div>
        <div class="value placeholder" id="ta-valve-state">---</div>
      </div>

      <div class="row">
        <div class="label">Rõhk 30 ms tagasi</div>
        <div class="value placeholder" id="ta-pressure-prev">---</div>
      </div>

      <div class="row">
        <div class="label">Rõhk praegu</div>
        <div class="value placeholder" id="ta-pressure-now">---</div>
      </div>
    </div>
  </div>

  <!-- CHART -->
  <div class="chart-card">
    <div class="chart-inner">
      <div class="chart-title">RÕHU REAALAEGNE GRAAFIK</div>
      <div class="chart-subtitle">pressure_now · 5 bar alarmijoon</div>
      <div class="chart-wrapper">
        <canvas id="ta-pressureChart"></canvas>
      </div>

      <!-- Optional note if Chart.js isn't loaded by the outer page -->
      <div id="ta-chart-missing" style="display:none; margin-top:12px; color:#94a3b8; font-size:12px;">
        Chart.js is not loaded on this page.
      </div>
    </div>
  </div>

  <script>
    (function(){
      // ---- Safe setters ----
      function setValue(id, value){
        var el = document.getElementById(id);
        if (!el) return;
        el.textContent = String(value);
        el.classList.remove("placeholder");
      }

      // ---- Chart init (expects Chart.js already on page) ----
      var chart = null;
      var data = null;
      var MAX_POINTS = 120;

      function initChartIfPossible(){
        var canvas = document.getElementById("ta-pressureChart");
        if (!canvas) return;

        if (typeof Chart === "undefined"){
          var m = document.getElementById("ta-chart-missing");
          if (m) m.style.display = "block";
          return;
        }

        var ctx = canvas.getContext("2d");
        data = {
          labels: [],
          datasets: [{
            label: "Rõhk praegu",
            data: [],
            tension: 0.25,
            borderWidth: 2,
            pointRadius: 0
          }]
        };

        chart = new Chart(ctx, {
          type: "line",
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 150 },
            plugins: {
              legend: { display: true }
            },
            interaction: { mode: "index", intersect: false },
            scales: {
              x: { ticks: { maxRotation: 0, autoSkip: true, autoSkipPadding: 12 } },
              y: { title: { display: true, text: "Rõhk (bar)" } }
            }
          }
        });
      }

      // Expose global hook for server / page to call:
      // payload = { uid, ts_ms, valve_state, pressure_prev, pressure_now }
      window.handleSensorUpdate = function(payload){
        if (!payload) return;

        setValue("ta-device-uid", payload.uid ?? "---");
        setValue("ta-ts-ms", payload.ts_ms ?? "---");
        setValue("ta-valve-state", payload.valve_state ?? "---");
        setValue("ta-pressure-prev", payload.pressure_prev ?? "---");
        setValue("ta-pressure-now", payload.pressure_now ?? "---");

        // Alarm > 5
        var pressureNowEl = document.getElementById("ta-pressure-now");
        var p = parseFloat(payload.pressure_now);
        if (pressureNowEl){
          if (!isNaN(p) && p > 5) pressureNowEl.classList.add("alarm");
          else pressureNowEl.classList.remove("alarm");
        }

        // Chart update
        if (!chart || !data) return;

        var ts = Number(payload.ts_ms);
        var label = isFinite(ts)
          ? new Date(ts).toLocaleTimeString("et-EE",{hour12:false})
          : new Date().toLocaleTimeString("et-EE",{hour12:false});

        data.labels.push(label);
        data.datasets[0].data.push(Number(payload.pressure_now));

        if (data.labels.length > MAX_POINTS){
          data.labels.shift();
          data.datasets[0].data.shift();
        }
        chart.update("none");
      };

      // init chart once DOM is ready (in case fragment is injected)
      if (document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", initChartIfPossible);
      } else {
        initChartIfPossible();
      }
    })();
  </script>
</div>
